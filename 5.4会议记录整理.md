# 5.4会议记录整理

## 1.问题答叙（总讲解）

### 1.思路梳理

***1.大部分代码只需要理解（内容已经完备）***

***2.（明白万能型红外发码的基础点）理解蓝牙通道的建立、数据的接收与上传,怎么把红外数据解析成红外发码***

### 2.对标回答

***1.蓝牙收码，获取红外数据包，然后用于蓝牙（HID）和红外发码，主要把这两个功能联系起来，是依靠于全方面的MCU，配有蓝牙芯片和外设（红外发送）***

***2.酷控红外数据库，直接可以调用，重心是如何把红外数据转化成红外发码***

***3.Makefile（脚本语言）的作用与程序运行顺序无关，其对我们的主要意义是明白和大概了解Makefile是用于把C/C++编译语言转化成bin文件二进制，最后在芯片里跑起来***

***4.蓝牙方面主要搞得东西在应用层，其余层面基本都已经完善，原理方面主要集中于蓝牙原理架构的GATT部分***

## 2.总结要点

### 1.最终目标

***把蓝牙从客户端获取的红外数据，转化成红外编码/蓝牙2.4GHZ波（HID）再反馈到APP中，进行一个功能实现***

### 2.下一步重点

***1.蓝牙SDK框架，有个大概的了解，能明白哪一部分是干什么的，能牛头对的上马嘴，把各方面做一个简单的联系***

***2.Makefile等未知领域的知识，花点时间区了解，不用区深入***

### 3.步骤计划

***1.读和了解SDK（读完进行分析和总结并反思）***

***2.蓝牙收发码的原理（有给不错的理解）***

***3.搞懂蓝牙和客户端、APP的联系以及在这个项目中的功能（HID）***

***4.搞懂红外在这个项目中功能，数据的收发、处理***

## 3.额外知识备注

### Makefile简述

**Makefile 是一个用于自动化编译程序的脚本文件，主要用于指定代码编译的规则、依赖关系及编译命令等信息，以便在代码发生变化时自动重新编译程序。Makefile 通常被用于 C/C++ 程序的编译和构建，也可以用于其他程序的编译和构建。
Makefile 中包含了需要编译的文件列表、编译器和编译选项、编译目标、依赖关系以及编译命令等信息。通过 Makefile，可以实现对程序的自动化编译、构建、测试和部署等工作，提高软件开发的效率和质量。
Makefile 的主要作用如下：
\1. 管理代码编译：Makefile 可以自动化管理代码编译，指定编译规则、依赖关系和编译命令等信息，以便在代码变化时自动重新编译程序。
\2. 管理程序构建：Makefile 可以自动化管理程序构建，包括生成目标文件、链接库文件、打包程序等工作，以便生成可执行的程序。
\3. 管理程序测试：Makefile 可以自动化管理程序测试，包括自动运行测试脚本、分析测试结果等工作，以便保证程序的质量。
\4. 管理程序部署：Makefile 可以自动化管理程序部署，包括打包程序、上传程序、配置环境等工作，以便快速部署程序到生产环境中。
总的来说，Makefile 主要用于自动化管理代码编译、构建、测试和部署等工作，以提高软件开发的效率和质量。在实际使用中，需要根据具体项目的需求和特点编写相应的 Makefile 文件。**

### HID简述

***HID 全称为 Human Interface Device，即人机接口设备。它是一种能够与计算机进行交互的设备，如键盘、鼠标、游戏手柄、扫描仪等等。
HID 设备连接到计算机后，需要发送 HID 报告来传递设备的状态信息。HID 报告是一种特殊的数据格式，用于描述设备的状态信息，包括按键状态、鼠标坐标、滚轮数据等等。HID 设备需要与计算机配合，按照特定的协议进行通信，从而实现设备控制与状态传输。
HID 设备的协议包括两种：Boot Protocol 和 Report Protocol。其中 Boot Protocol 是一种简单的协议，用于传输键盘、鼠标等设备的状态信息，而 Report Protocol 是一种更为复杂的协议，支持多种数据类型和数据传输方式，可以用于传输更加复杂的设备状态信息。
在 HID 设备的实现过程中，需要对设备的硬件、驱动程序和应用程序进行开发和调试。硬件开发需要根据 HID 设备的要求进行设计，包括电路、芯片、固件等等。驱动程序开发需要根据 HID 设备的协议进行编写，从而实现设备状态的解析和传输。应用程序可以利用驱动程序提供的接口，实现对 HID 设备的控制和状态监控等功能。
总的来说，HID 设备是计算机与人类交互的重要手段之一，具有广泛的应用前景。在实际开发过程中，需要对 HID 设备的协议、硬件和驱动程序进行深入研究，从而实现设备的高效、稳定地工作。***

### 蓝牙构架所需知识简述

#### 1 设备之间如何建立连接(Gap层)

**若BLE设备之间要进行数据传输，就需要形成一个通信通道。GAP(通用访问配置文件)来负责这个通道的形成和维护。  
GAP指示两台将要连接和通信的设备的角色，一台作为`Central`(一般为智能手机这种功能强大的设备)，另一台作为`Peripheral`(一般指需要较少功率的设备)。**设备之间建立连接的流程如下**：  
（1）当作为`Peripheral`的设备准备好连接时，它必须进入广播状态并在主广播通道(37、38和39)上广播数据包  
（2）作为`Central`的设备必须转换到`Scanning`状态，并在这三个通道上监听广播包。  
（3）当检测到广播包时，`Central`通过发送连接请求包来向`Peripheral`发起连接请求。其中，`Central`设备负责管理连接，可以直接决定连接的一些参数，其中一些参数为：**

+   `Connection Interval`：连接的间隔时间
+   `Peripheral Latency`：指定`Peripheral`可以忽略多少的连接事件
+   `Channel Map`：指定将使用37个数据传输通道中的哪一个进行传输

`Central`决定这些参数，以连接请求包的方式将这些参数发送到`Peripheral`，此时就创建了连接。接着，`Central`将在一个`Connection Interval`后向`Peripheral`发送数据包。如果`Peripheral`接收到数据包并向`Central`返回一个数据包，则认为连接已经建立。![在这里插入图片描述](https://img-blog.csdnimg.cn/8379bdfc9d9e43198c6983768fd2210f.png)  
设备建立连接后，设备之间就可以进行双向数据传输。那么，数据传输到底是如何完成的呢?这就是ATT和GATT要做的事了。

#### 2 ATT

#### 2.1 角色

ATT协议定义了一些角色，每个角色都有它特定的功能。这些角色都是基于Client-Server架构的。

+   服务器(Server)：作为一个数据库，存储可被客户端读写的数据
+   客户端(Client)：请求服务器上的数据

但有一个误区：`Central`设备将作为ATT的客户端，`Peripheral`设备将作为ATT的服务端。但实际上`Central`和`Peripheral`都既可以做服务端，也可以做客户端。比如，一个可以记录步数、心率等信息的蓝牙智能手环。当手环想向手机传输这些信息的时候，它作为服务端，而手机作为客户端；手环上可以显示当前的时间，这是由手机传过去的，此时手机作为服务端，而手环作为客户端。

#### 2.2 作为服务端时ATT的属性

服务端设备作为一个数据库来存储需要分享给客户端的数据。ATT服务端和Mysql、Oracle这些数据库一样，需要实现：存储和组织数据的方法、访问数据的标准机制。所以，**ATT协议负责为服务端设备提供客户端能读写的指定格式化的数据，以及客户端访问、写入和读取数据的机制**。

**1、Attributes**  
ATT协议定义了一个叫`attribute`的数据结构，该数据结构由下列四个字段组成：  
![在这里插入图片描述](https://img-blog.csdnimg.cn/e230d0e0152a4904a78baf60ff4e5360.png#pic_center)

+   `Attribute Handle` ：用于给客户端查找一个服务端`attribute`的`uint16_t`类型的唯一标识符，也就是给attribute一个“地址”
+   `Attribute Type` (UUID) ：全局唯一的2或16字节的UUID标识符，定义储存于`Attribute Value`中的数值的具体类型和含义，UUID分为两种：`Service UUID`和`Characteristic UUID`
    +   标准的UUID为16字节，为了减小传输的数据量，如果UUID设置为2字节，则BLE内部会将2字节的UUID根据其模板替换为16位的UUID
    +   资料：[16-bit UUID Numbers Document](https://download.csdn.net/download/tilblackout/87140079)
+   `Attribute Value`：属性值
+   `Attribute Permissions`：它表示访问`Attribute Value`的权限，或者说设置一个属性的安全等级。

在服务端，数据以如下Attribute表格形式存储：  
![在这里插入图片描述](https://img-blog.csdnimg.cn/bebde68872fb4a65a4a3796502a1943c.png)  
一个BLE服务端的所有Attributes都通过增加`Attribute handle`的值存储在它的数据库中。

+   句柄之间可以有空隙，只要保证句柄值是按照递增顺序存储的即可

**2、Attribute访问方式**

ATT协议还定义了读写属性的方式。具体的方式取决于发起属性访问过程的是客户端还是服务端。  
①客户端发起属性访问，有两种操作——`Write`和`Read`

+   客户端使用`Read`从服务器读取属性的值，服务器响应属性的值。
+   客户端使用`Write`将一个属性的值写入服务器，服务器响应写操作是否成功。

②服务端发起属性访问，有两种操作——`Notification`和`Indication`  
![在这里插入图片描述](https://img-blog.csdnimg.cn/28750fc884cd4cd49a4cf56f09951bb1.png#pic_center)

+   `Notification`：当Attribute发生改变时，服务端使用该种方式向客户端发送更新后的属性值，客户端收到后不响应此操作
+   `Indication`：与`Notification`类似，但是客户端必须发送是否正确收到该Attribute的响应

**3、Attribute访问权限**  
访问权限决定客户端是否可以读、写或读写其中某个属性值，可选权限如下：

+   None：没有读写权限
+   Readable：可读
+   Writable：可写
+   Readable and writable：可读写

注意：`Attribute handle`和`Attribute type`是公共信息，而`Attribute Value`和`Attribute Permissions`是私有信息。为了让客户端可以访问这两个私有信息，服务端需要进行如下操作：

+   读或写的身份验证
+   读或写的授权
+   读或写的加密和配对

从上面的分析可知，ATT协议通过增加属性的句柄数，以线性方式将数据作为Attribute存储在表中。但是，如果我们想要知道存储在服务器上的数据之间的关系，该怎么办呢？

+   关系：类似于在电脑中文件和文件夹的关系，我们直观地理解同一文件夹中的文件是相关的，这将使得在复杂的关系中的查找变得更加容易。

GATT层负责定义分层数据结构，该结构演示了ATT服务器中存储的数据之间的关系或连接。

#### 3 GATT

GATT协议层定义了一个框架，在该框架中，服务端数据库上的Attribute可以被组织起来而有一定的层次关系。GATT层定义了一个4层树形框架，其中根节点为`Profile`(配置)，它有不同的`Services`(服务)，不同的服务有不同的`Characteristics`(特征)，不同的特征通过一个具体的`Value`(值)或者`Descriptor`(描述符)来定义，如下图所示。  
![在这里插入图片描述](https://img-blog.csdnimg.cn/2c12dce3c252458f98d7460a42c7ede8.png#pic_center)  
**1、Characteristic**  
`Characteristic`是一个基本的存储单元，即一个attribute类型。每个`Characteristic`由以下三个部分组成：

+   特征声明(`Characteristic declaration`)
+   特征值(`Characteristic value`)：实际存储的应用数据
+   特征描述符(`Characteristic descriptor(s)`)：该字段可选，它会存储更多关于`Characteristic`的信息，比如`Characteristic`的范围(如整数类型,定义其范围只能在0~100间)、`Characteristic`单位等。

一个`Characteristic`的定义如下图所示：  
![在这里插入图片描述](https://img-blog.csdnimg.cn/8e21fb9988b248d29a52c96ab2f3ae1e.png#pic_center)  
①`Chracteristic Declaration`  
![在这里插入图片描述](https://img-blog.csdnimg.cn/1af6f5ed0c164bf3940132ee62d81deb.png#pic_center)  
②`Chracteristic Value`  
![在这里插入图片描述](https://img-blog.csdnimg.cn/3f0b630f79e941f99f0c9e29009dd81d.png#pic_center)

③`Characteristic descriptor`  
有以下几种特征描述符：

+   `Characteristic extended properties`：允许扩展的`properties`加到`characteristic`
+   `Characteristic user description`：允许设备用一段字符串来联系`characteristic`
+   `Client characteristic configuration`：如果`characteristic`能被Notified或Indicated，则该描述符是必要的。客户端必须写这个描述符来使能Notifications或Indications。
    +   该描述符较常用，缩写为`CCCD`，它用来使/失能GATT服务端某个`Characteristic`的`Indications`和`Notifications`功能，其UUID固定为0x2902。当使能了某个`Characteristic`的`Indications`和`Notifications`功能后，每当服务端的该`Characteristic`值改变的时候，客户端都可以收到通知。
+   `Server characteristic configuration`：可选描述符
+   `Characteristic presentation format`：允许定义`Chracteristic`的表示格式
+   `Characteristic aggregation format`：允许多个`Characteristic presentation format`聚合

**2、Services**  
`Services`主要用来组织数据而不是存储数据，它分为主服务(`primary service`)，次服务(`secondary service`)和包含服务(`include service`)。一个`Service`可以包含多个`Characteristics`，比如对于蓝牙手环来说，有两个`Services`：  
①心率：包含两个`Characteristics`，一个是心率值，一个是`CCCD`  
②设备信息：包含一个`Characteristics`，即设备信息

`Service`是多个`Chracteristic`的集合。(`Primary`)`Service`可以包含一个或多个`secondary service`。下图为`Service Declaration`：  
![在这里插入图片描述](https://img-blog.csdnimg.cn/b98ca006859048148adcddaaa4f142ac.png#pic_center)  
一个`Service Include Declaration`可能会跟在`Service Declaration`后面  
![在这里插入图片描述](https://img-blog.csdnimg.cn/6169ff1154134b3baed0dfcb36256c4c.png#pic_center)

+   `include attribute handle`：服务所包含的`secondary service`的`attribute`的句柄
+   `End group handle`：服务所包含的`secondary service`中最后一个`attribute`的句柄

**3、Profile**  
`Profile`是上面分层结构的最顶层，它包含了服务端支持的特定服务。有些服务是可选的，而有些服务是必须实现的，这是为了确保两个有相同`GATT profile`的设备能够相互通信。

* * *

服务端的`Attribute Table`的一个例子如下图所示，每个`Services`和`Characteristics`都是使用ATT中的`Attributes`数据结构描述的，他们都需要先声明。  
![在这里插入图片描述](https://img-blog.csdnimg.cn/604a107fe8ac473cb46b24c01742205c.png)  
同时，GATT层可以使用`ATT requests`和`ATT response`这样的请求-应答机制，实现读写服务端的数据、获得GATT服务器的`primary services`和订阅/取消订阅服务端某个`characteristic`的`notifications`/`indications`等功能。![在这里插入图片描述](https://img-blog.csdnimg.cn/f884d4676802462f984b9551b5dfa37c.png)

#### 4 总结

+   ATT协议负责管理设备之间的数据存储。它为服务端提供了一种客户端可以进行读写的`Attribute`数据结构，并为客户端提供了访问、写入和读取数据的机制(访问方法和权限)。
+   GATT层定义了一个层次化的数据结构，它有助于理解存储在服务端中数据(`GATT Profile`)之间的关系。